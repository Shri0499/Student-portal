<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guidely & IBS Learning Center</title>
  
  <!-- LIBRARIES -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- FIREBASE COMPAT -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; min-height: 100vh; display: flex; flex-direction: column; }
    
    .card { background: white; border-radius: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; margin-bottom: 1rem; overflow: hidden; }
    .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-success { background: #16a34a; color: white; }
    .input-field { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-top: 4px; }
    
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50; padding: 1rem; }
    .modal-content { background: white; padding: 1.5rem; border-radius: 1rem; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    
    .tab-btn { flex: 1; padding: 1rem; text-align: center; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
    .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }

    #sidebar { width: 16rem; background: #1f2937; color: white; flex-shrink: 0; height: calc(100vh - 4rem); overflow-y: auto; }
    .nav-link { display: block; padding: 0.75rem 1rem; cursor: pointer; }
    .nav-link:hover { background: #374151; }
    .nav-link.active { background: #2563eb; }
    
    .badge { background: #ef4444; color: white; font-size: 0.75rem; padding: 0.1rem 0.4rem; border-radius: 999px; font-weight: bold; }

    @media (max-width: 768px) {
        #sidebar { display: none; }
        #mobile-nav { display: flex; }
    }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm h-16 flex-shrink-0 flex items-center justify-between px-6 z-20">
    <div class="font-bold text-xl text-blue-700">Guidely & IBS</div>
    <div class="flex gap-4 items-center">
        <span id="user-display" class="hidden text-sm text-gray-500 font-mono bg-gray-100 px-2 py-1 rounded"></span>
        <button id="logout-btn" onclick="app.logout()" class="hidden text-sm text-red-600 font-bold border border-red-200 px-3 py-1 rounded">Log Out</button>
    </div>
  </header>

  <!-- Body -->
  <div class="flex flex-grow overflow-hidden">
      <!-- Sidebar (Admin Only) -->
      <nav id="sidebar" class="hidden md:hidden">
          <div class="p-4 font-bold text-lg border-b border-gray-700">Menu</div>
          <a onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-link">Dashboard</a>
          <a onclick="app.nav('students')" id="nav-students" class="nav-link">Students</a>
          <a onclick="app.nav('approvals')" id="nav-approvals" class="nav-link">Payments <span id="pay-badge" class="ml-2 bg-red-500 text-white text-xs px-2 rounded-full hidden">0</span></a>
      </nav>

      <!-- Main Content -->
      <main id="main-content" class="flex-grow p-4 overflow-y-auto bg-gray-50">
          <div id="loading-screen" class="flex flex-col items-center justify-center h-full">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
              <p class="mt-4 text-gray-500">Connecting...</p>
          </div>
      </main>
  </div>

  <!-- Mobile Nav -->
  <div id="mobile-nav" class="md:hidden bg-white border-t flex justify-around p-2 hidden flex-shrink-0">
      <button onclick="app.nav('dashboard')" class="p-2 text-sm font-bold text-gray-600">Dash</button>
      <button onclick="app.nav('students')" class="p-2 text-sm font-bold text-gray-600">Students</button>
      <button onclick="app.nav('approvals')" class="p-2 text-sm font-bold text-gray-600">Pay</button>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop" onclick="app.closeModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
          <div id="modal-body"></div>
          <button onclick="app.closeModal()" class="mt-4 w-full btn btn-secondary">Close</button>
      </div>
  </div>

  <script>
    // ==========================================
    // STEP 1: PASTE FIREBASE KEYS HERE
    // ==========================================
    const firebaseConfig = {
       apiKey: "AIzaSyCIbJUeEBbB9-W2x1Ni7B_azsS1DFOtlOs",
  	authDomain: "studentportal-7ba75.firebaseapp.com",
  	projectId: "studentportal-7ba75",
  	storageBucket: "studentportal-7ba75.appspot.com",
  	messagingSenderId: "529968274796",
  	appId: "1:529968274796:web:a37ca33c9e653a468de749"
    };

    // ==========================================
    // STEP 2: UPI DETAILS
    // ==========================================
    const UPI_ID = "ibsjpnagar-3@okhdfcbank"; 
    const PAYEE_NAME = "Guidely & IBS Learning Center";
    const ADMIN_ID = "shriniketan.j";

    // --- INIT ---
    let db, auth;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        auth.signInAnonymously().catch(e => alert("Auth Error: " + e.message));
    } catch (e) {
        document.body.innerHTML = `<div class="p-10 text-center text-red-600 font-bold">Config Error: ${e.message}</div>`;
    }

    // --- STATE ---
    let studentsData = [];
    let pendingApprovals = [];
    let currentUser = null;
    let isAdmin = false;
    let loginTab = 'student';
    let activePage = 'dashboard';
    let qrTimerInterval = null;
    let currentStudent = null;
    let feeChart = null;
    let enrollChart = null;
    let selectedBatch = 'All';

    // --- DATA SANITIZER ---
    function sanitize(id, d) {
        return {
            id: id,
            name: d.name || "Unknown",
            email: d.email || "",
            batchName: d.batchName || "N/A",
            totalFees: Number(d.totalFees) || 0,
            courseFee: Number(d.courseFee) || Number(d.totalFees) || 0,
            feesPaid: Number(d.feesPaid) || 0,
            discountGiven: Number(d.discountGiven) || 0,
            enrollmentType: d.enrollmentType || "Banking",
            enrollmentDate: d.enrollmentDate || new Date().toISOString(),
            bankingBooks: d.bankingBooks || "No",
            sscBooks: d.sscBooks || "No",
            guidelyApp: d.guidelyApp || "No",
            ibsApp: d.ibsApp || "No",
            paymentStatus: d.paymentStatus || "not_paid"
        };
    }

    // --- APP CORE ---
    window.app = {
        init: () => {
            auth.onAuthStateChanged(user => {
                if(user) {
                    const local = localStorage.getItem('portalUser');
                    if(local) app.loginSuccess(local);
                    else app.renderLogin();
                } else app.renderLogin();
            });
        },

        setTab: (mode) => {
            loginTab = mode;
            app.renderLogin();
        },
        
        submitLogin: (e) => {
            e.preventDefault();
            const id = document.getElementById('login-id').value.trim();
            if(!id) return;
            if(loginTab === 'student' && id === ADMIN_ID) return alert("Use Admin Tab");
            if(loginTab === 'admin' && id !== ADMIN_ID) return alert("Invalid Admin ID");
            localStorage.setItem('portalUser', id);
            app.loginSuccess(id);
        },

        loginSuccess: (id) => {
            currentUser = id;
            isAdmin = (id === ADMIN_ID);
            
            const logoutBtn = document.getElementById('logout-btn');
            if(logoutBtn) logoutBtn.classList.remove('hidden');
            
            const userDisplay = document.getElementById('user-display');
            if(userDisplay) {
                userDisplay.classList.remove('hidden');
                userDisplay.textContent = id;
            }
            
            const sidebar = document.getElementById('sidebar');
            const mobileNav = document.getElementById('mobile-nav');
            
            if(isAdmin) {
                if(sidebar) {
                    sidebar.classList.remove('hidden');
                    sidebar.classList.add('flex');
                }
                if(mobileNav) {
                    mobileNav.classList.remove('hidden');
                    mobileNav.classList.add('flex');
                }
                app.startAdminListener();
            } else {
                if(sidebar) {
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('flex');
                }
                if(mobileNav) {
                    mobileNav.classList.add('hidden');
                    mobileNav.classList.remove('flex');
                }
                app.startStudentListener(id);
            }
        },

        logout: () => {
            localStorage.removeItem('portalUser');
            location.reload();
        },

        renderLogin: () => {
            // Safe UI Reset
            const sidebar = document.getElementById('sidebar');
            if(sidebar) sidebar.classList.add('hidden');
            
            const mobileNav = document.getElementById('mobile-nav');
            if(mobileNav) mobileNav.classList.add('hidden');
            
            const headerActions = document.getElementById('header-actions');
            if(headerActions) headerActions.classList.add('hidden');

            const isStu = loginTab === 'student';
            document.getElementById('main-content').innerHTML = `
                <div class="max-w-md mx-auto card mt-10 overflow-hidden">
                    <div class="flex border-b">
                        <div onclick="app.setTab('student')" class="tab-btn ${isStu ? 'active' : ''}">Student</div>
                        <div onclick="app.setTab('admin')" class="tab-btn ${!isStu ? 'active' : ''}">Admin</div>
                    </div>
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-center mb-6">${isStu ? 'Student' : 'Admin'} Login</h2>
                        <form onsubmit="app.submitLogin(event)">
                            <input id="login-id" class="input-field mb-6" placeholder="${isStu ? 'Enter Student ID' : 'Enter Admin ID'}" required>
                            <button class="btn btn-primary w-full py-3">Log In</button>
                        </form>
                    </div>
                </div>
            `;
        },

        // --- ADMIN ---
        startAdminListener: () => {
            db.collection("students").onSnapshot(snap => {
                const list = [];
                snap.forEach(doc => list.push(sanitize(doc.id, doc.data())));
                studentsData = list;
                app.refreshCurrentPage();
            });
            
            db.collection("paymentApprovals").where("status", "==", "pending").onSnapshot(snap => {
                const list = [];
                snap.forEach(doc => list.push({id: doc.id, ...doc.data()}));
                pendingApprovals = list;
                const badge = document.getElementById('pay-badge');
                if(badge) {
                    if(list.length > 0) { badge.innerText = list.length; badge.classList.remove('hidden'); }
                    else badge.classList.add('hidden');
                }
                if(activePage === 'approvals') app.refreshCurrentPage();
            });
            
            app.nav('dashboard');
        },

        nav: (page) => {
            activePage = page;
            app.refreshCurrentPage();
        },

        setBatchFilter: () => {
             selectedBatch = document.getElementById('dash-batch-filter').value;
             app.renderDashboard(document.getElementById('main-content'));
        },

        refreshCurrentPage: () => {
            const container = document.getElementById('main-content');
            if(activePage === 'dashboard') app.renderDashboard(container);
            else if(activePage === 'students') app.renderStudentList(container);
            else if(activePage === 'approvals') app.renderApprovals(container);
        },

        renderDashboard: (container) => {
            // Get Batches
            const batches = ["All", ...new Set(studentsData.map(s => s.batchName))];
            
            // Filter Data
            let filteredData = studentsData;
            if(selectedBatch !== 'All') {
                filteredData = studentsData.filter(s => s.batchName === selectedBatch);
            }

            const total = filteredData.length;
            const collected = filteredData.reduce((acc, s) => acc + s.feesPaid, 0);
            const pending = filteredData.reduce((acc, s) => acc + (s.totalFees - s.feesPaid), 0);
            
            const banking = filteredData.filter(s => s.enrollmentType.toLowerCase().includes('banking') && !s.enrollmentType.toLowerCase().includes('ssc')).length;
            const both = filteredData.filter(s => s.enrollmentType.toLowerCase().includes('ssc')).length;

            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Dashboard</h2>
                    <select id="dash-batch-filter" onchange="app.setBatchFilter()" class="input-field w-48">
                        ${batches.map(b => `<option value="${b}" ${b===selectedBatch?'selected':''}>${b}</option>`).join('')}
                    </select>
                </div>

                <div class="grid md:grid-cols-3 gap-4 mb-8">
                    <div class="card p-6 border-l-4 border-blue-500">
                        <div class="text-gray-500">Total Admissions</div><div class="text-3xl font-bold">${total}</div>
                    </div>
                    <div class="card p-6 border-l-4 border-green-500">
                        <div class="text-gray-500">Total Fees Collected</div><div class="text-3xl font-bold text-green-600">₹${collected.toLocaleString()}</div>
                    </div>
                    <div class="card p-6 border-l-4 border-yellow-500">
                        <div class="text-gray-500">Total Fees Pending</div><div class="text-3xl font-bold text-yellow-600">₹${pending.toLocaleString()}</div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="card p-4"><canvas id="chart1"></canvas></div>
                    <div class="card p-4"><canvas id="chart2"></canvas></div>
                </div>
            `;
            
            setTimeout(() => {
                if(feeChart) feeChart.destroy();
                if(enrollChart) enrollChart.destroy();
                enrollChart = new Chart(document.getElementById('chart1'), {
                    type: 'doughnut', data: { labels: ['Banking', 'Both'], datasets: [{ data: [banking, both], backgroundColor: ['#3b82f6', '#10b981'] }] }
                });
                feeChart = new Chart(document.getElementById('chart2'), {
                    type: 'bar', data: { labels: ['Collected', 'Pending'], datasets: [{ label: '₹', data: [collected, pending], backgroundColor: ['#10b981', '#f59e0b'] }] }
                });
            }, 100);
        },

        renderStudentList: (container) => {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Students</h2>
                    <div class="flex gap-2">
                         <button onclick="app.exportCSV()" class="btn btn-secondary text-sm">Export</button>
                         <button onclick="app.showAddModal()" class="btn btn-primary">Add Student</button>
                    </div>
                </div>
                <input onkeyup="app.filterTable(this.value)" placeholder="Search..." class="input-field mb-4">
                <div class="card overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100"><tr><th class="p-3">Name</th><th class="p-3">Batch</th><th class="p-3">Fees</th><th class="p-3">Status</th><th class="p-3">Action</th></tr></thead>
                        <tbody id="stu-table">${app.genRows(studentsData)}</tbody>
                    </table>
                </div>
            `;
        },

        filterTable: (val) => {
            const filtered = studentsData.filter(s => s.name.toLowerCase().includes(val.toLowerCase()));
            document.getElementById('stu-table').innerHTML = app.genRows(filtered);
        },

        genRows: (list) => {
            return list.map(s => {
                const due = s.totalFees - s.feesPaid;
                let status = "";
                if(due <= 0) status = `<span class="text-green-600 font-bold">Paid</span>`;
                else status = `<span class="text-yellow-600 font-bold">Due: ₹${due}</span>`;

                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-bold text-blue-600 cursor-pointer" onclick="app.openEdit('${s.id}')">${s.name}<br><span class="text-xs text-gray-400 font-normal">${s.id}</span></td>
                    <td class="p-3">${s.batchName}</td>
                    <td class="p-3">
                        <div><span class="font-bold">Total:</span> ₹${s.totalFees}</div>
                        <div class="text-green-600"><span class="font-bold">Paid:</span> ₹${s.feesPaid}</div>
                    </td>
                    <td class="p-3">${status}</td>
                    <td class="p-3"><button onclick="app.openEdit('${s.id}')" class="btn btn-secondary text-xs">Edit</button></td>
                </tr>`;
            }).join('');
        },

        renderApprovals: (container) => {
             let html = `<h2 class="text-2xl font-bold mb-4">Approvals</h2>`;
             if(pendingApprovals.length === 0) html += `<div class="card p-4 text-gray-500">No pending items.</div>`;
             pendingApprovals.forEach(p => {
                 html += `
                    <div class="card p-4 flex flex-col md:flex-row justify-between md:items-center gap-4">
                        <div><div class="font-bold">${p.studentName}</div><div class="text-blue-600">Paid: ₹${p.amountPaid}</div></div>
                        <div class="flex gap-2">
                            <button onclick="app.viewProof('${p.imageDataUrl}')" class="btn btn-secondary">Proof</button>
                            <button onclick="app.processPay('${p.id}', '${p.studentId}', ${p.amountPaid}, true)" class="btn btn-success">Approve</button>
                            <button onclick="app.processPay('${p.id}', '${p.studentId}', 0, false)" class="btn btn-danger">Reject</button>
                        </div>
                    </div>`;
             });
             container.innerHTML = html;
        },

        // --- ADMIN ACTIONS ---
        showAddModal: () => {
            app.openModal(`
                <h3 class="font-bold text-lg mb-4">Add Student</h3>
                <input id="n-name" class="input-field mb-2" placeholder="Name">
                <input id="n-email" type="email" class="input-field mb-2" placeholder="Email (e.g. user@mail.com)">
                <select id="n-type" class="input-field mb-2">
                    <option value="banking">Banking (₹16k)</option>
                    <option value="banking_ssc">Banking+SSC (₹18k)</option>
                </select>
                <input id="n-batch" class="input-field mb-2" placeholder="Batch (e.g. July 15)">
                <label class="text-xs text-gray-500">Enrollment Date</label>
                <input id="n-date" type="date" class="input-field mb-4">
                <button onclick="app.submitAdd()" class="btn btn-primary w-full">Save</button>
            `);
        },

        submitAdd: async () => {
            const name = document.getElementById('n-name').value;
            const email = document.getElementById('n-email').value;
            const type = document.getElementById('n-type').value;
            const batch = document.getElementById('n-batch').value;
            const date = document.getElementById('n-date').value;

            if(!name || !email || !batch || !date) return alert("Fill all fields");
            // Email Check
            if(!email.includes('@') || !email.includes('.')) return alert("Invalid Email");

            const fee = (type === 'banking_ssc') ? 18000 : 16000;
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '.') + '.' + Math.floor(100+Math.random()*900);

            try {
                await db.collection("students").doc(id).set({
                    name: name, email: email, enrollmentType: type, batchName: batch, enrollmentDate: date,
                    courseFee: fee, discountGiven: 0, totalFees: fee, feesPaid: 0,
                    paymentStatus: 'not_paid', bankingBooks: 'No', sscBooks: 'No', guidelyApp: 'No', ibsApp: 'No',
                    createdAt: new Date().toISOString()
                });
                alert("Added: " + id); app.closeModal();
            } catch(e) { alert(e.message); }
        },

        openEdit: (id) => {
            const s = studentsData.find(x => x.id === id);
            app.openModal(`
                <h3 class="font-bold mb-4">Edit: ${s.name}</h3>
                <div class="mb-4 p-3 bg-gray-50 rounded">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="text-xs">Discount (₹)</label><input id="e-disc" type="number" class="input-field" value="${s.discountGiven}"></div>
                        <div><label class="text-xs">Total Paid (₹)</label><input id="e-paid" type="number" class="input-field mb-4" value="${s.feesPaid}"></div>
                    </div>
                    <button onclick="app.saveEdit('${id}')" class="btn btn-primary w-full text-sm">Update Financials</button>
                </div>
                <h4 class="font-bold text-sm mb-2">Resources</h4>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div><label class="text-xs">Bank Books</label><select id="e-bank" class="input-field text-xs"><option ${s.bankingBooks=='No'?'selected':''}>No</option><option ${s.bankingBooks=='Yes'?'selected':''}>Yes</option></select></div>
                    <div><label class="text-xs">SSC Books</label><select id="e-ssc" class="input-field text-xs"><option ${s.sscBooks=='No'?'selected':''}>No</option><option ${s.sscBooks=='Yes'?'selected':''}>Yes</option><option ${s.sscBooks=='Not opted'?'selected':''}>Not opted</option></select></div>
                    <div><label class="text-xs">Guidely</label><select id="e-guide" class="input-field text-xs"><option ${s.guidelyApp=='No'?'selected':''}>No</option><option ${s.guidelyApp=='Yes'?'selected':''}>Yes</option></select></div>
                    <div><label class="text-xs">IBS</label><select id="e-ibs" class="input-field text-xs"><option ${s.ibsApp=='No'?'selected':''}>No</option><option ${s.ibsApp=='Yes'?'selected':''}>Yes</option></select></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.saveResources('${id}')" class="btn btn-secondary w-full">Save Resources</button>
                    <button onclick="app.del('${id}')" class="btn btn-danger">Delete</button>
                </div>
            `);
        },

        saveEdit: async (id) => {
            const s = studentsData.find(x => x.id === id);
            const disc = Number(document.getElementById('e-disc').value);
            const paid = Number(document.getElementById('e-paid').value);
            const newTotal = s.courseFee - disc;
            let status = 'not_paid';
            if(paid > 0) status = 'half_paid';
            if(paid >= newTotal) status = 'fully_paid';

            await db.collection("students").doc(id).update({
                discountGiven: disc, totalFees: newTotal, feesPaid: paid, paymentStatus: status
            });
            alert("Financials Updated");
        },

        saveResources: async (id) => {
            await db.collection("students").doc(id).update({
                bankingBooks: document.getElementById('e-bank').value,
                sscBooks: document.getElementById('e-ssc').value,
                guidelyApp: document.getElementById('e-guide').value,
                ibsApp: document.getElementById('e-ibs').value
            });
            app.closeModal();
        },

        del: async (id) => {
            if(confirm("Delete permanently?")) { await db.collection("students").doc(id).delete(); app.closeModal(); }
        },

        processPay: async (pid, sid, amt, ok) => {
            if(ok) {
                const doc = await db.collection("students").doc(sid).get();
                if (doc.exists) {
                     const s = sanitize(sid, doc.data());
                     const newPaid = s.feesPaid + amt;
                     let status = 'half_paid';
                     if (newPaid >= s.totalFees) status = 'fully_paid';
                     await db.collection("students").doc(sid).update({ feesPaid: newPaid, paymentStatus: status });
                     await db.collection("paymentApprovals").doc(pid).update({ status: 'approved' });
                }
            } else {
                await db.collection("paymentApprovals").doc(pid).update({ status: 'rejected' });
            }
            alert(ok ? "Approved" : "Rejected");
        },
        
        viewProof: (url) => {
            app.openModal(`<img src="${url}" class="rounded max-h-[80vh] mx-auto"><button onclick="app.closeModal()" class="btn btn-secondary w-full mt-4">Close</button>`);
        },

        // --- STUDENT LOGIC ---
        startStudentListener: (id) => {
            document.getElementById('main-content').innerHTML = `<div class="p-10 text-center">Loading Profile...</div>`;
            db.collection("students").doc(id).onSnapshot(doc => {
                if(!doc.exists) { document.getElementById('main-content').innerHTML = `<div class="p-10 text-center text-red-600 font-bold">Record Not Found</div>`; return; }
                const s = sanitize(id, doc.data());
                currentStudent = s;
                app.renderStudentDash(s);
            });
        },

        renderStudentDash: (s) => {
            const due = s.totalFees - s.feesPaid;
            const date = new Date(s.enrollmentDate);
            const deadline = new Date(date.setDate(date.getDate() + 15));
            const daysLeft = Math.ceil((deadline - new Date()) / (1000*60*60*24));

            let banner = "";
            if(s.paymentStatus === 'pending_verification') banner = `<div class="bg-blue-100 text-blue-800 p-4 rounded font-bold text-center mb-6">⏳ Verification Pending</div>`;
            else if(due <= 0) banner = `<div class="bg-green-100 text-green-800 p-4 rounded font-bold text-center mb-6">✅ Fully Paid</div>`;
            else if(daysLeft > 0) banner = `<div class="bg-yellow-100 text-yellow-800 p-4 rounded font-bold text-center mb-6">⚠️ Due: ${daysLeft} Days Left</div>`;
            else banner = `<div class="bg-red-100 text-red-800 p-4 rounded font-bold text-center mb-6">❌ Deadline Passed</div>`;

            document.getElementById('main-content').innerHTML = `
                <div class="max-w-2xl mx-auto mt-4">
                    <div class="card overflow-hidden mb-6">
                        <div class="bg-blue-600 p-6 text-white">
                            <h2 class="text-2xl font-bold">Hi, ${s.name.split(' ')[0]}</h2>
                            <p class="opacity-90">${s.batchName}</p>
                        </div>
                        <div class="p-6">
                            ${banner}
                            <div class="grid grid-cols-2 gap-4 border rounded p-4 bg-gray-50 mb-6">
                                <div><div class="text-xs text-gray-500">Total Fee</div><div class="font-bold">₹${s.totalFees}</div></div>
                                <div><div class="text-xs text-gray-500">Paid</div><div class="font-bold text-green-600">₹${s.feesPaid}</div></div>
                                <div class="col-span-2 border-t pt-2 flex justify-between"><span class="text-gray-500 font-bold">Due</span><span class="text-xl text-red-600 font-bold">₹${due}</span></div>
                            </div>
                            <div class="mb-6 space-y-2 text-sm">
                                <div class="flex justify-between border-b pb-1"><span>Banking</span><b>${s.bankingBooks}</b></div>
                                <div class="flex justify-between border-b pb-1"><span>SSC</span><b>${s.sscBooks}</b></div>
                                <div class="flex justify-between border-b pb-1"><span>Guidely</span><b>${s.guidelyApp}</b></div>
                                <div class="flex justify-between border-b pb-1"><span>IBS</span><b>${s.ibsApp}</b></div>
                            </div>
                            ${due > 0 && s.paymentStatus !== 'pending_verification' ? `
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <button onclick="app.showQR(${due})" class="btn btn-primary">Pay Full</button>
                                    <button onclick="app.showQR(${s.totalFees/2})" class="btn btn-secondary">Pay Half</button>
                                </div>
                                <button onclick="app.showUpload()" class="btn btn-success w-full">Upload Proof</button>
                            ` : `<button onclick="app.genPDF()" class="btn btn-secondary w-full border-2">Receipt</button>`}
                        </div>
                    </div>
                </div>
            `;
        },

        // --- UTILS ---
        openModal: (html) => {
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        },
        closeModal: (e) => {
            if(e) e.stopPropagation();
            document.getElementById('modal').style.display = 'none';
            if(qrTimerInterval) clearInterval(qrTimerInterval);
        },
        
        showQR: (amt) => {
            if(UPI_ID.includes("YOUR")) return alert("Admin Config Error");
            const link = `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(PAYEE_NAME)}&am=${amt}&cu=INR`;
            app.openModal(`
                <div class="p-6 text-center">
                    <h3 class="font-bold text-xl mb-2">Scan to Pay ₹${amt}</h3>
                    <div id="qrcode" class="flex justify-center my-4"></div>
                    <div id="qr-timer" class="text-red-500 font-bold mt-2">5:00</div>
                    <button onclick="app.closeModal()" class="btn btn-secondary w-full mt-4">Close</button>
                </div>
            `);
            new QRCode(document.getElementById("qrcode"), { text: link, width: 180, height: 180 });
            let t = 300;
            if(qrTimerInterval) clearInterval(qrTimerInterval);
            qrTimerInterval = setInterval(() => {
                t--; document.getElementById('qr-timer').innerText = `${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`;
                if(t<=0) { clearInterval(qrTimerInterval); app.closeModal(); alert("Expired"); }
            }, 1000);
        },

        showUpload: () => {
            app.openModal(`
                <h3 class="font-bold mb-4">Upload Proof</h3>
                <input id="up-amt" type="number" class="input-field mb-3" placeholder="Amount Paid">
                <input id="up-file" type="file" class="input-field mb-4" accept="image/*">
                <button onclick="app.handleUpload()" class="btn btn-primary w-full">Submit</button>
            `);
        },

        handleUpload: () => {
            const file = document.getElementById('up-file').files[0];
            const amt = Number(document.getElementById('up-amt').value);
            if(!file || !amt) return alert("Fill all fields");
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await db.collection("paymentApprovals").add({
                        studentId: currentUser, studentName: window.currentStudent.name,
                        amountPaid: amt, imageDataUrl: e.target.result, status: "pending", date: new Date().toISOString()
                    });
                    await db.collection("students").doc(currentUser).update({ paymentStatus: 'pending_verification' });
                    alert("Uploaded! Waiting for approval."); app.closeModal();
                } catch(err) { alert(err.message); }
            };
            reader.readAsDataURL(file);
        },

        genPDF: () => {
            const s = currentStudent;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18);
            doc.text(PAYEE_NAME, 105, 20, {align:'center'});
            doc.setFontSize(12);
            doc.text("Official Payment Receipt", 105, 30, {align:'center'});
            
            // Details
            doc.text(`Name: ${s.name}`, 20, 50);
            doc.text(`Batch: ${s.batchName}`, 20, 60);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 140, 50);
            
            // Financials
            doc.text(`Course Fee:`, 20, 80);     doc.text(`Rs. ${s.courseFee}`, 160, 80, {align:'right'});
            doc.text(`Discount:`, 20, 90);       doc.text(`- Rs. ${s.discountGiven}`, 160, 90, {align:'right'});
            doc.line(20, 95, 190, 95);
            doc.setFont(undefined, 'bold');
            doc.text(`Total Payable:`, 20, 105);  doc.text(`Rs. ${s.totalFees}`, 160, 105, {align:'right'});
            doc.text(`Amount Paid:`, 20, 115);    doc.text(`Rs. ${s.feesPaid}`, 160, 115, {align:'right'});
            
            const status = s.feesPaid >= s.totalFees ? "PAID IN FULL" : "PARTIAL PAYMENT";
            doc.setTextColor(s.feesPaid >= s.totalFees ? 0 : 200, s.feesPaid >= s.totalFees ? 128 : 0, 0);
            doc.text(`STATUS: ${status}`, 20, 135);
            
            doc.save("Receipt.pdf");
        },

        exportCSV: () => {
            if(!studentsData.length) return alert("No Data");
            let csv = "Name,ID,Batch,Total,Paid,Due,Status\n";
            studentsData.forEach(s => {
                csv += `"${s.name}","${s.id}","${s.batchName}",${s.totalFees},${s.feesPaid},${s.totalFees-s.feesPaid},${s.paymentStatus}\n`;
            });
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "Students.csv";
            link.click();
        }
    };

    app.init();
  </script>
</body>
</html>